@model Sistema_Gestion_TechNova.Models.Venta

<h2>Registrar Venta</h2>

<form method="post" id="ventaForm">

    <!-- Cliente -->
    <div class="mb-3">
        <label>Cliente</label>
        <select asp-for="ClienteId" class="form-control" required>
            <option value="">Seleccione...</option>
            @foreach (var c in ViewBag.Clientes)
            {
                <option value="@c.Id">@c.NombreCompleto</option>
            }
        </select>
    </div>

    <!-- Productos -->
    <h4>Productos</h4>

    <table class="table" id="tablaProductos">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cant</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>

        <tbody></tbody>
    </table>

    <button type="button" class="btn btn-secondary" onclick="AgregarProducto()">Agregar Producto</button>

    <h3 class="mt-4">Total: $<span id="totalVenta">0</span></h3>

    <button class="btn btn-primary mt-3">Registrar Venta</button>

</form>

<script>
    const productos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Productos));
    let contador = 0;

    function AgregarProducto() {

        let row = `
        <tr id="row_${contador}">
            <td>
                <select name="Items[${contador}].ProductoId" class="form-control" onchange="ActualizarPrecio(${contador})">
                    <option value="">Seleccione...</option>
                    ${productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join("")}
                </select>
            </td>
            <td>
                <input type="number" name="Items[${contador}].PrecioUnitario" class="form-control" readonly />
            </td>
            <td>
                <input type="number" name="Items[${contador}].Cantidad" class="form-control" min="1" value="1"
                    oninput="ActualizarSubtotal(${contador})" />
            </td>
            <td>
                <input type="number" name="Items[${contador}].Subtotal" class="form-control" readonly />
            </td>
            <td>
                <button type="button" class="btn btn-danger" onclick="Eliminar(${contador})">X</button>
            </td>
        </tr>`;

        document.querySelector("#tablaProductos tbody").insertAdjacentHTML("beforeend", row);

        contador++;
    }

    function ActualizarPrecio(i) {
        let id = document.querySelector(`[name="Items[${i}].ProductoId"]`).value;
        let p = productos.find(x => x.id === id);

        if (!p) return;

        document.querySelector(`[name="Items[${i}].PrecioUnitario"]`).value = p.precioUnitario;

        ActualizarSubtotal(i);
    }

    function ActualizarSubtotal(i) {
        let precio = parseFloat(document.querySelector(`[name="Items[${i}].PrecioUnitario"]`).value);
        let cant = parseInt(document.querySelector(`[name="Items[${i}].Cantidad"]`).value);

        let subtotal = precio * cant;
        document.querySelector(`[name="Items[${i}].Subtotal"]`).value = subtotal;

        ActualizarTotal();
    }

    function Eliminar(i) {
        document.getElementById(`row_${i}`).remove();
        ActualizarTotal();
    }

    function ActualizarTotal() {
        let subtotales = document.querySelectorAll("input[name$='Subtotal']");
        let total = 0;

        subtotales.forEach(s => total += parseFloat(s.value || 0));

        document.getElementById("totalVenta").innerText = total;
    }
</script>
